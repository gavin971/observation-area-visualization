<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="author" content="Liu, An-Chi">
  <meta name="keywords" content="台大,大氣,觀測坪">
  <meta name="theme-color" content="#ecdaa7" />
  <link rev="made" href="mailto:phy.tiger@gmail.com">
  <link rev="made" href="https://tigercosmos.xyz/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>台大大氣觀測坪</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://gw.alipayobjects.com/os/antv/assets/g2/3.0.4-beta.2/g2.min.js"></script>
</head>

<body>
  <h1 align="center">台大大氣觀測坪觀測數據</h1>
  <div class="row">
    <div class="col-sm-4">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>項目</th>
            <th>數值</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>海平面氣壓 hPa</td>
            <td id='DD_MMP2'></td>
          </tr>
          <tr>
            <td>氣溫 ℃</td>
            <td id='DD_T'></td>
          </tr>
          <tr>
            <td>相對溼度 ％</td>
            <td id='DD_RH'></td>
          </tr>
          <tr>
            <td>風向</td>
            <td id='DD_10D'></td>
          </tr>
          <tr>
            <td>風速 m/s</td>
            <td id='DD_F10'></td>
          </tr>
          <tr>
            <td>分鐘降雨量 mm</td>
            <td id='DD_Rmn'></td>
          </tr>
          <tr>
            <td>小時累積降雨量 mm</td>
            <td id='DD_R'></td>
          </tr>
          <tr>
            <td>0cm地溫 ℃</td>
            <td id='DD_T00'></td>
          </tr>
          <tr>
            <td>5cm地中溫度 ℃</td>
            <td id='DD_ST005'></td>
          </tr>
          <tr>
            <td>10cm地中溫度 ℃</td>
            <td id='DD_ST010'></td>
          </tr>
          <tr>
            <td>20cm地中溫度 ℃</td>
            <td id='DD_ST020'></td>
          </tr>
          <tr>
            <td>50cm地中溫度 ℃</td>
            <td id='DD_ST050'></td>
          </tr>
          <tr>
            <td>100cm地中溫度 ℃</td>
            <td id='DD_ST100'></td>
          </tr>
        </tbody>
      </table>
      <h4>製作：劉安齊</h4>
    </div>
    <div class="col-sm-8">
      <div class="col-sm-6">
        <p>壓力</p>
        <div id="chart1"></div>
      </div>
      <div class="col-sm-6">
        <p>雨量</p>
        <div id="chart2"></div>
      </div>
      <div class="col-sm-6">
        <p>溫度</p>
        <div id="chart3"></div>
      </div>
      <div class="col-sm-6">
        <p>風向</p>
        <div id="chart4"></div>
      </div>
      <div class="col-sm-6">
        <p>風速</p>
        <div id="chart5"></div>
      </div>
    </div>

  </div>

  <script>
    let data = {};
    const url = 'http://140.112.67.183/mospc/returnJson.php?file=NTU_OBS_DATA.json';

    function renderTable() {
      $('#DD_MMP2').html(data.DD_MMP2);
      $('#DD_T').html(data.DD_T);
      $('#DD_RH').html(data.DD_RH);
      $('#DD_10D').html(data.DD_10D);
      $('#DD_F10').html(data.DD_F10);
      $('#DD_Rmn').html(data.DD_Rmn);
      $('#DD_R').html(data.DD_R);
      $('#DD_T00').html(data.DD_T00);
      $('#DD_ST005').html(data.DD_ST005);
      $('#DD_ST010').html(data.DD_ST010);
      $('#DD_ST020').html(data.DD_ST020);
      $('#DD_ST050').html(data.DD_ST050);
      $('#DD_ST100').html(data.DD_ST100);
    }

    function renderChart() {
      const dataPress = [];
      const dataRain = [];
      const dataTemp = [];
      const dataWindDir = [];
      const dataWindSpeed = [];
      for (let i = 0; i < 24; i++) {
        dataPress.push({
          hour: i,
          value: data['press_24'][i]
        });
        dataRain.push({
          hour: i,
          value: data['rain_24'][i]
        });
        dataTemp.push({
          hour: i,
          value: data['temp_24'][i]
        });
        dataWindDir.push({
          hour: i,
          value: data['wind_dir_24'][i]
        });
        dataWindSpeed.push({
          hour: i,
          value: data['wind_speed_24'][i]
        });
      }

      drawChart('chart1', dataPress);
      drawChart('chart2', dataRain);
      drawChart('chart3', dataTemp);
      drawChart('chart4', dataWindDir);
      drawChart('chart5', dataWindSpeed);

      function drawChart(chartName, chartData) {
        const chart = new G2.Chart({
          container: chartName,
          forceFit: true,
          height: 220
        });
        chart.source(chartData);
        chart.scale('value', {
          min: 0
        });
        chart.scale('hour', {
          range: [0, 1]
        });
        chart.tooltip({
          crosshairs: {
            type: 'line'
          }
        });
        chart.axis('hour', {
          label: {
            formatter: val => {
              const hour = new Date().getHours();
  
              let hr = hour - 23 + Number(val);

              if (hr < 0) {
                hr += 24;
              }
              return hr;
            }
          }
        });
        chart.line().position('hour*value');
        chart.point().position('hour*value').size(4).shape('circle').style({
          stroke: '#fff',
          lineWidth: 1
        });
        chart.render();
      }
    }

    fetch(url)
      .then(res => res.json())
      .then((out) => {
        data = out;
        renderChart();
        renderTable();
      })
      .catch(err => {
        throw err
      });

    setInterval(renderTable, 1000);
    setInterval(renderChart, 36000000);
  </script>
</body>

</html>